---
title: "Introduction to Spike"
date: 2018-08-01T10:32:07+08:00
draft: true
---

## 前言

最近花了大概兩個禮拜研究了 RISCV 的官方模擬器 (riscv-isa-sim) Spike。

內容包含

- 安裝
- 基本使用
- 如何加入新的指令

## 安裝

在使用 spike 之前，需要安裝 riscv-tools，所需要的工具大致如下

- **riscv-gnu-toolchain: RISC-V cross-compiler**
- riscv-fesvr: a "front-end" server that services calls between the host and target processors on the Host-Target InterFace 
- **riscv-isa-sim: ISA simulator, as kown as spike**
- **riscv-opcodes: the enumeration of all RISC-V opcodes executable by the simulator**
- riscv-pk: a proxy kernel that services system calls generated by code built and linked with the RISC-V Newlib port
- riscv-tests: a set of assembly tests and benchmarks

粗體的部份是使用 spike 會需要理解的部份。

```shell
git clone https://github.com/riscv/riscv-tools.git
cd riscv-tools
git submodule update --init --recursive
export RISCV=/path/to/install/riscv/toolchain
./build.sh
export $RISCV/bin to $PATH
```

> 覺得編譯速度不夠快可以去修改 build.sh 使用多核心


## 如何使用 spike

寫程式 -> 用 cross-over compiler 編譯出 riscv machine code -> 使用 spike 運行此執行檔

- 寫程式
```c
#include <stdio.h>
int main() {
    int a = 1*2*3*4;
    printf("%d\n", a);
    return 0;
}
```
- 使用cross-over compiler 編譯
```shell
riscv64-unknown-elf-gcc main.c -o main
```
- 使用 spike 運行此程式
```
spike pk main
```

## 如何加入新的指令

spike 是一個 riscv 的模擬器，最主要的目標就是在沒有支援 riscv ISA 的處理器上，也可以執行以 riscv machine code 為主的程式。方便程式開發與測試。其本身就是在定義一個符合 riscv 規格的處理器。有 register 有 memory 最大程度的重現真實CPU的行為。

> 當然，結果正確無誤比起流程正確無誤重要。

- 定義指令編碼與生成mask
- 描述指令行為
- 註冊進spike
- 測試新的指令

